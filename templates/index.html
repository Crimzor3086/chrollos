<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrollo AI Tradebot</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/date-fns.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.1/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --primary-dark: #18130a;
            --secondary-dark: #222016;
            --accent-gold: #ffd700;
            --accent-gold-hover: #bfa14a;
            --accent-red: #b86c25;
            --text-light: #fff8e1;
            --neon-blue: #00f3ff;
            --neon-purple: #b388ff;
        }

        body {
            background-color: var(--primary-dark);
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
            padding-top: 60px;
        }

        .navbar {
            background-color: var(--secondary-dark);
            border-bottom: 1px solid var(--accent-gold);
            padding: 0.5rem 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .navbar-brand {
            color: var(--accent-gold);
            font-weight: 700;
            font-size: 1.5rem;
            text-decoration: none;
        }

        .navbar-brand i {
            color: var(--neon-blue);
        }

        .nav-link {
            color: var(--text-light);
            padding: 0.5rem 1rem;
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            color: var(--accent-gold);
        }

        .nav-link.active {
            color: var(--accent-gold);
            border-bottom: 2px solid var(--accent-gold);
        }

        .card {
            background-color: var(--secondary-dark);
            border: 1px solid var(--accent-gold);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: rgba(191, 161, 74, 0.1);
            border-bottom: 1px solid var(--accent-gold);
            padding: 1rem;
            border-radius: 12px 12px 0 0;
        }

        .card-title {
            color: var(--accent-gold);
            font-weight: 600;
            margin: 0;
        }

        .btn-primary {
            background-color: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--primary-dark);
            font-weight: 500;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--accent-gold-hover);
            border-color: var(--accent-gold-hover);
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: var(--accent-red);
            border-color: var(--accent-red);
        }

        .chart-container {
            height: 400px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--accent-gold);
            border-radius: 12px;
            background: var(--primary-dark);
            padding: 1rem;
        }

        .table-dark {
            background-color: var(--secondary-dark);
            color: var(--text-light);
        }

        .table-dark th {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            font-weight: 600;
        }

        .table-dark td {
            border-color: rgba(191, 161, 74, 0.2);
        }

        .form-control, .form-select {
            background-color: var(--primary-dark);
            border: 1px solid var(--accent-gold);
            color: var(--text-light);
            border-radius: 8px;
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--primary-dark);
            border-color: var(--neon-blue);
            color: var(--text-light);
            box-shadow: 0 0 0 0.25rem rgba(0, 243, 255, 0.25);
        }

        .notification {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .notification-info {
            background-color: rgba(0, 243, 255, 0.1);
            border-left-color: var(--neon-blue);
        }

        .notification-warning {
            background-color: rgba(255, 211, 0, 0.1);
            border-left-color: var(--accent-gold);
        }

        .notification-danger {
            background-color: rgba(184, 108, 37, 0.1);
            border-left-color: var(--accent-red);
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }

            .card {
                margin-bottom: 1rem;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            background: var(--secondary-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 4px;
        }

        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
            color: white;
        }
        .dropdown-item-text {
            color: #6c757d;
        }
        #accountDropdown:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="notifications-container" class="container mt-3"></div>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                        <i class="bi bi-cpu"></i> Chrollo AI
                    </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/trading">Trading</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">Analytics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">Settings</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span id="bot-status-badge" class="status-badge status-offline me-3">
                        <i class="bi bi-circle-fill"></i> OFFLINE
                    </span>
                    <div class="dropdown me-2">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="walletDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-wallet2"></i> Connect Wallet
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="walletDropdown">
                            <li><a class="dropdown-item" href="#" id="connect-phantom"><i class="bi bi-wallet2"></i> Phantom</a></li>
                            <li><a class="dropdown-item" href="#" id="connect-solflare"><i class="bi bi-wallet2"></i> Solflare</a></li>
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="accountDropdown" data-bs-toggle="dropdown" disabled>
                            <i class="bi bi-person-circle"></i> Account
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="accountDropdown">
                            <li><span class="dropdown-item-text">Balance: <span id="wallet-balance">0 SOL</span></span></li>
                            <li><span class="dropdown-item-text">Network: <span id="wallet-network">-</span></span></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/settings"><i class="bi bi-gear"></i> Settings</a></li>
                            <li><a class="dropdown-item" href="#" id="disconnect-wallet"><i class="bi bi-box-arrow-right"></i> Disconnect</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Bot Controls</h5>
                    </div>
                    <div class="card-body d-flex align-items-center gap-3">
                        <button id="start-bot-btn" class="btn btn-primary">Start Bot</button>
                        <button id="stop-bot-btn" class="btn btn-danger">Stop Bot</button>
                        <span id="bot-status-text" class="ms-3">Status: <span id="bot-status-value">Unknown</span></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Portfolio Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <canvas id="portfolio-chart"></canvas>
                            </div>
                            <div class="col-md-6">
                                <h3 class="mb-3">$<span id="total-balance">0.00</span></h3>
                                <div class="mb-3">
                                    <span class="text-muted">24h P&L:</span>
                                    <span id="pnl-24h" class="ms-2">0.00%</span>
                                </div>
                                <div class="mb-3">
                                    <span class="text-muted">Active Trades:</span>
                                    <span id="active-trades" class="ms-2">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Pair</th>
                                        <th>Action</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-activity">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div id="notifications">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Market Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="chart-container">
                                    <canvas id="market-chart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="table-responsive">
                                    <table class="table table-dark">
                                        <thead>
                                            <tr>
                                                <th>Metric</th>
                                                <th>Value</th>
                                            </tr>
                                        </thead>
                                        <tbody id="market-metrics">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Bootstrap first -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load Solana scripts -->
    <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>

    <script>
        let connection;
        let wallet;
        let currentAccount = null;

        async function initSolana() {
            try {
                // Initialize Solana connection
                connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));
                
                // Check if Phantom is installed
                if (!window.solana || !window.solana.isPhantom) {
                    showPhantomInstallGuide();
                    return;
                }

                // Connect to Phantom wallet
                try {
                    const resp = await window.solana.connect();
                    console.log("Phantom connected:", resp);
                    
                    // Get the public key as a string
                    const publicKey = resp.publicKey.toString();
                    currentAccount = publicKey;
                    
                    // Get balance
                    const balance = await connection.getBalance(new solanaWeb3.PublicKey(publicKey));
                    const balanceSol = balance / solanaWeb3.LAMPORTS_PER_SOL;
                    
                    // Get network info
                    const networkName = 'devnet'; // We're using devnet for now
                    
                    console.log("Wallet info:", {
                        address: publicKey,
                        balance: balanceSol,
                        network: networkName
                    });
                    
                    // Update UI
                    updateWalletInfo({
                        address: publicKey,
                        balance: balanceSol,
                        network: networkName
                    });

                    // Notify backend
                    try {
                        const response = await fetch('/api/wallet_connected', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                address: publicKey,
                                balance: balanceSol,
                                network: networkName
                            })
                        });
                        
                        const data = await response.json();
                        if (data.status === 'success') {
                            showSuccess("Wallet connected successfully!");
                        } else {
                            showError(data.message || "Failed to connect wallet");
                        }
                    } catch (error) {
                        console.error("Error connecting to backend:", error);
                        showError("Connected to wallet but failed to sync with backend. Some features may be limited.");
                    }
                } catch (err) {
                    console.error("Error connecting to Phantom:", err);
                    showError("Failed to connect to Phantom wallet. Please try again.");
                }
            } catch (error) {
                console.error("Error initializing Solana:", error);
                showError("Failed to initialize Solana connection. Please try again.");
            }
        }

        // Initialize charts
        function initializeCharts() {
            const portfolioCtx = document.getElementById('portfolio-chart').getContext('2d');
            const portfolioChart = new Chart(portfolioCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#ffd700',
                            '#00f3ff',
                            '#b388ff',
                            '#b86c25'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff8e1'
                            }
                        }
                    }
                }
            });

            const marketCtx = document.getElementById('market-chart').getContext('2d');
            const marketChart = new Chart(marketCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'BTC/USDT',
                        data: [],
                        borderColor: '#ffd700',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff8e1'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: '#fff8e1'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour'
                            },
                            ticks: {
                                color: '#fff8e1'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            window.portfolioChart = portfolioChart;
            window.marketChart = marketChart;
        }

        let updateIntervals = {
            portfolio: null,
            marketData: null,
            recentActivity: null,
            notifications: null
        };

        function clearAllIntervals() {
            Object.values(updateIntervals).forEach(interval => {
                if (interval) clearInterval(interval);
            });
        }

        function showError(message) {
            const notificationsContainer = document.getElementById('notifications-container');
            if (!notificationsContainer) {
                console.error('Notifications container not found');
                return;
            }
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show';
            errorDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            notificationsContainer.insertBefore(errorDiv, notificationsContainer.firstChild);
        }

        function showSuccess(message) {
            const notificationsContainer = document.getElementById('notifications-container');
            if (!notificationsContainer) {
                console.error('Notifications container not found');
                return;
            }
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success alert-dismissible fade show';
            successDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            notificationsContainer.insertBefore(successDiv, notificationsContainer.firstChild);
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/bot_status');
                const data = await response.json();
                
                const statusBadge = document.getElementById('bot-status-badge');
                if (data.running) {
                    statusBadge.className = 'status-badge status-live';
                    statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> LIVE';
                } else {
                    statusBadge.className = 'status-badge status-offline';
                    statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> OFFLINE';
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        async function updatePortfolio() {
            try {
                const response = await fetch('/api/portfolio');
                const data = await response.json();
                
                if (data.status === 'error') {
                    showError(data.message);
                    return;
                }
                
                if (data.status === 'success' && data.balances) {
                    const totalBalance = data.balances.reduce((sum, asset) => 
                        sum + parseFloat(asset.usdt_value || 0), 0);
                    
                    document.getElementById('total-balance').textContent = totalBalance.toFixed(2);
                    
                    if (data.pnl_24h !== undefined) {
                        const pnlElement = document.getElementById('pnl-24h');
                        const pnlValue = parseFloat(data.pnl_24h);
                        pnlElement.textContent = `${pnlValue >= 0 ? '+' : ''}${pnlValue.toFixed(2)}%`;
                        pnlElement.className = `ms-2 ${pnlValue >= 0 ? 'text-success' : 'text-danger'}`;
                    }
                    
                    if (data.active_trades !== undefined) {
                        document.getElementById('active-trades').textContent = data.active_trades;
                    }

                    if (window.portfolioChart) {
                        const nonZeroBalances = data.balances.filter(asset => 
                            parseFloat(asset.usdt_value || 0) > 0
                        );
                        
                        window.portfolioChart.data.labels = nonZeroBalances.map(asset => asset.asset);
                        window.portfolioChart.data.datasets[0].data = nonZeroBalances.map(asset => 
                            parseFloat(asset.usdt_value || 0)
                        );
                        window.portfolioChart.update();
                    }
                }
            } catch (error) {
                console.error('Error updating portfolio:', error);
                showError('Failed to update portfolio data. Please try again later.');
            }
        }

        async function updateMarketData() {
            try {
                const response = await fetch('/api/market_data');
                const data = await response.json();
                
                if (data.status === 'error') {
                    showError(data.message);
                    return;
                }
                
                if (data.status === 'success' && data.klines) {
                    if (window.marketChart) {
                        const chartData = data.klines.map(kline => ({
                            x: new Date(kline.timestamp),
                            y: parseFloat(kline.close)
                        }));
                        
                        window.marketChart.data.datasets[0].data = chartData;
                        window.marketChart.update();
                    }

                    if (data.metrics) {
                        const metricsTable = document.getElementById('market-metrics');
                        metricsTable.innerHTML = '';
                        
                        const metrics = [
                            { label: '24h Volume', value: `$${parseFloat(data.metrics.volume_24h).toLocaleString()}` },
                            { label: '24h High', value: `$${parseFloat(data.metrics.high_24h).toLocaleString()}` },
                            { label: '24h Low', value: `$${parseFloat(data.metrics.low_24h).toLocaleString()}` },
                            { label: 'Price Change', value: `${data.metrics.price_change_24h >= 0 ? '+' : ''}${data.metrics.price_change_24h}%` }
                        ];

                        metrics.forEach(metric => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${metric.label}</td>
                                <td>${metric.value}</td>
                            `;
                            metricsTable.appendChild(row);
                        });
                    }
                }
            } catch (error) {
                console.error('Error updating market data:', error);
                showError('Failed to update market data. Please try again later.');
            }
        }

        async function updateRecentActivity() {
            try {
                const response = await fetch('/api/recent_activity');
                const data = await response.json();
                
                if (data.status === 'error') {
                    showError(data.message);
                    return;
                }
                
                const tbody = document.getElementById('recent-activity');
                tbody.innerHTML = '';
                
                if (data.status === 'success' && data.activity) {
                    data.activity.forEach(activity => {
                        const row = document.createElement('tr');
                        const timestamp = new Date(activity.time).toLocaleString();
                        const amount = parseFloat(activity.total).toLocaleString('en-US', {
                            style: 'currency',
                            currency: 'USD'
                        });
                        
                        row.innerHTML = `
                            <td>${timestamp}</td>
                            <td>${activity.symbol}</td>
                            <td>${activity.side}</td>
                            <td>${amount}</td>
                            <td><span class="badge ${activity.side === 'BUY' ? 'bg-success' : 'bg-danger'}">${activity.side}</span></td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error updating recent activity:', error);
                showError('Failed to update recent activity. Please try again later.');
            }
        }

        async function updateNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const data = await response.json();
                
                if (data.status === 'error') {
                    showError(data.message);
                    return;
                }
                
                const container = document.getElementById('notifications');
                container.innerHTML = '';
                
                if (data.status === 'success' && data.notifications) {
                    data.notifications.forEach(notification => {
                        const div = document.createElement('div');
                        div.className = `notification notification-${notification.type}`;
                        div.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${notification.type}</h6>
                                    <p class="mb-1">${notification.message}</p>
                                </div>
                                <small>${new Date(notification.time).toLocaleTimeString()}</small>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Error updating notifications:', error);
                showError('Failed to update notifications. Please try again later.');
            }
        }

        async function connectWallet(address) {
            try {
                const balance = await connection.getBalance(new solanaWeb3.PublicKey(address));
                const balanceSol = balance / solanaWeb3.LAMPORTS_PER_SOL;
                
                const network = await connection.getVersion();
                const networkName = {
                    'mainnet-beta': 'Solana Mainnet',
                    'testnet': 'Solana Testnet',
                    'devnet': 'Solana Devnet'
                }[network['solana-core']] || `Unknown Network (${network['solana-core']})`;

                updateWalletInfo({
                    address: address,
                    balance: balanceSol,
                    network: networkName
                });

                try {
                const response = await fetch('/api/wallet_connected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        address: address,
                            balance: balanceSol,
                        network: networkName
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    showSuccess("Wallet connected successfully!");
                } else {
                    showError(data.message || "Failed to connect wallet");
                    }
                } catch (error) {
                    console.error("Error connecting to backend:", error);
                    showError("Connected to wallet but failed to sync with backend. Some features may be limited.");
                }
            } catch (error) {
                console.error("Error connecting wallet:", error);
                showError("Failed to connect wallet. Please try again.");
            }
        }

        function updateWalletInfo(walletInfo) {
            const balanceElement = document.getElementById('wallet-balance');
            const networkElement = document.getElementById('wallet-network');
            const walletDropdown = document.getElementById('walletDropdown');
            const accountDropdown = document.getElementById('accountDropdown');
            
            if (walletInfo) {
                // Update balance and network
                balanceElement.textContent = `${walletInfo.balance.toFixed(4)} SOL`;
                networkElement.textContent = walletInfo.network;
                
                // Update wallet button to show connected state
                walletDropdown.innerHTML = `
                    <i class="bi bi-wallet2"></i> ${walletInfo.address.slice(0, 4)}...${walletInfo.address.slice(-4)}
                `;
                walletDropdown.classList.add('btn-success');
                walletDropdown.classList.remove('btn-primary');
                
                // Enable account dropdown
                accountDropdown.disabled = false;
            } else {
                // Reset to default state
                balanceElement.textContent = '0 SOL';
                networkElement.textContent = '-';
                
                // Reset wallet button
                walletDropdown.innerHTML = `
                    <i class="bi bi-wallet2"></i> Connect Wallet
                `;
                walletDropdown.classList.add('btn-primary');
                walletDropdown.classList.remove('btn-success');
                
                // Disable account dropdown
                accountDropdown.disabled = true;
            }
        }

        async function disconnectWallet() {
            if (currentAccount) {
                try {
                    await window.solana.disconnect();
                    const response = await fetch('/api/wallet_disconnected', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ address: currentAccount })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        currentAccount = null;
                        updateWalletInfo(null);
                        showSuccess("Wallet disconnected successfully!");
                    } else {
                        showError(data.message || "Failed to disconnect wallet");
                    }
                } catch (error) {
                    console.error("Error disconnecting wallet:", error);
                    showError("Failed to disconnect wallet. Please try again.");
                }
            }
        }

        async function updateBotStatusText() {
            try {
                const response = await fetch('/api/bot_status');
                const data = await response.json();
                const statusValue = document.getElementById('bot-status-value');
                if (data.is_running) {
                    statusValue.textContent = 'Running';
                    statusValue.className = 'text-success';
                } else {
                    statusValue.textContent = 'Stopped';
                    statusValue.className = 'text-danger';
                }
            } catch (error) {
                console.error('Error updating bot status:', error);
                document.getElementById('bot-status-value').textContent = 'Unknown';
                document.getElementById('bot-status-value').className = 'text-warning';
            }
        }

        document.getElementById('start-bot-btn').onclick = async function() {
            try {
                const requestBody = {
                    wallet_address: currentAccount || null
                };

                const response = await fetch('/api/start_bot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to start bot');
                }

                const data = await response.json();
                if (data.status === 'success') {
                    showSuccess('Bot started successfully');
            } else {
                    showError(data.error || 'Failed to start bot');
                }
                updateBotStatusText();
            } catch (error) {
                console.error('Error starting bot:', error);
                showError(error.message || 'Failed to start bot. Please try again.');
            }
        };

        document.getElementById('stop-bot-btn').onclick = async function() {
            try {
                const requestBody = {
                    wallet_address: currentAccount || null
                };

                const response = await fetch('/api/stop_bot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to stop bot');
                }

                const data = await response.json();
                if (data.status === 'success') {
                    showSuccess('Bot stopped successfully');
                } else {
                    showError(data.error || 'Failed to stop bot');
                }
                updateBotStatusText();
            } catch (error) {
                console.error('Error stopping bot:', error);
                showError(error.message || 'Failed to stop bot. Please try again.');
            }
        };

        document.getElementById('connect-phantom').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                if (!window.solana || !window.solana.isPhantom) {
                    showPhantomInstallGuide();
                    return;
                }
                await initSolana();
            } catch (error) {
                console.error("Error connecting to Phantom:", error);
                showError("Failed to connect to Phantom wallet. Please try again.");
            }
        });

        document.getElementById('connect-solflare').addEventListener('click', async function(e) {
            e.preventDefault();
            showError("Solflare wallet support coming soon!");
        });

        document.getElementById('disconnect-wallet').addEventListener('click', async function(e) {
            e.preventDefault();
            await disconnectWallet();
        });

        function showPhantomInstallGuide() {
            const notifications = document.getElementById('notifications');
            const guideDiv = document.createElement('div');
            guideDiv.className = 'notification notification-info';
            guideDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">Install Phantom Wallet</h6>
                        <p class="mb-1">To use this application, you need to install Phantom Wallet:</p>
                        <ol class="mb-2">
                            <li>Visit <a href="https://phantom.app/download" target="_blank" class="text-light">Phantom.app</a></li>
                            <li>Click "Download" and install the extension</li>
                            <li>Create a new wallet or import an existing one</li>
                            <li>Refresh this page after installation</li>
                        </ol>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            `;
            notifications.insertBefore(guideDiv, notifications.firstChild);

            const connectButtons = document.querySelectorAll('#connect-phantom, #connect-solflare');
            connectButtons.forEach(button => {
                button.classList.add('disabled');
                button.style.opacity = '0.5';
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            updateBotStatusText();
            setInterval(updateBotStatusText, 5000);
            
            // Check if Phantom is already connected
            if (window.solana && window.solana.isPhantom && window.solana.isConnected) {
                initSolana();
            }
        });
    </script>
</body>
</html> 