<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrollo AI Tradebot</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/fonts/bootstrap-icons.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/date-fns.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.1/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --primary-dark: #18130a;
            --secondary-dark: #222016;
            --accent-gold: #ffd700;
            --accent-gold-hover: #bfa14a;
            --accent-red: #b86c25;
            --text-light: #fff8e1;
            --neon-blue: #00f3ff;
            --neon-purple: #b388ff;
        }

        body {
            background-color: var(--primary-dark);
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
            padding-top: 60px; /* Add padding for fixed navbar */
        }

        /* Navigation Bar Styles */
        .navbar {
            background-color: var(--secondary-dark);
            border-bottom: 1px solid var(--accent-gold);
            padding: 0.5rem 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .navbar-brand {
            color: var(--accent-gold);
            font-weight: 700;
            font-size: 1.5rem;
            text-decoration: none;
        }

        .navbar-brand i {
            color: var(--neon-blue);
        }

        .nav-link {
            color: var(--text-light);
            padding: 0.5rem 1rem;
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            color: var(--accent-gold);
        }

        .nav-link.active {
            color: var(--accent-gold);
            border-bottom: 2px solid var(--accent-gold);
        }

        /* Top Bar Styles */
        .top-bar {
            background-color: var(--secondary-dark);
            border-bottom: 1px solid var(--accent-gold);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-gold);
            text-decoration: none;
        }

        .logo i {
            color: var(--neon-blue);
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
        }

        .status-live {
            background-color: rgba(0, 255, 0, 0.1);
            color: #00ff00;
            border: 1px solid #00ff00;
        }

        .status-offline {
            background-color: rgba(255, 0, 0, 0.1);
            color: #ff0000;
            border: 1px solid #ff0000;
        }

        /* Card Styles */
        .card {
            background-color: var(--secondary-dark);
            border: 1px solid var(--accent-gold);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: rgba(191, 161, 74, 0.1);
            border-bottom: 1px solid var(--accent-gold);
            padding: 1rem;
            border-radius: 12px 12px 0 0;
        }

        .card-title {
            color: var(--accent-gold);
            font-weight: 600;
            margin: 0;
        }

        /* Button Styles */
        .btn-primary {
            background-color: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--primary-dark);
            font-weight: 500;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--accent-gold-hover);
            border-color: var(--accent-gold-hover);
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: var(--accent-red);
            border-color: var(--accent-red);
        }

        /* Chart Container */
        .chart-container {
            height: 400px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--accent-gold);
            border-radius: 12px;
            background: var(--primary-dark);
            padding: 1rem;
        }

        /* Table Styles */
        .table-dark {
            background-color: var(--secondary-dark);
            color: var(--text-light);
        }

        .table-dark th {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            font-weight: 600;
        }

        .table-dark td {
            border-color: rgba(191, 161, 74, 0.2);
        }

        /* Form Controls */
        .form-control, .form-select {
            background-color: var(--primary-dark);
            border: 1px solid var(--accent-gold);
            color: var(--text-light);
            border-radius: 8px;
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--primary-dark);
            border-color: var(--neon-blue);
            color: var(--text-light);
            box-shadow: 0 0 0 0.25rem rgba(0, 243, 255, 0.25);
        }

        /* Notifications */
        .notification {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .notification-info {
            background-color: rgba(0, 243, 255, 0.1);
            border-left-color: var(--neon-blue);
        }

        .notification-warning {
            background-color: rgba(255, 211, 0, 0.1);
            border-left-color: var(--accent-gold);
        }

        .notification-danger {
            background-color: rgba(184, 108, 37, 0.1);
            border-left-color: var(--accent-red);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .top-bar {
                padding: 0.5rem 0;
            }

            .chart-container {
                height: 300px;
            }

            .card {
                margin-bottom: 1rem;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            background: var(--secondary-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-cpu"></i> Chrollo AI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/trading">Trading</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">Analytics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">Settings</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span id="bot-status-badge" class="status-badge status-offline me-3">
                        <i class="bi bi-circle-fill"></i> OFFLINE
                    </span>
                    <div class="dropdown me-2">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="walletDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-wallet2"></i> Connect Wallet
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="walletDropdown">
                            <li><a class="dropdown-item" href="#" id="connect-phantom"><i class="bi bi-wallet2"></i> Phantom</a></li>
                            <li><a class="dropdown-item" href="#" id="connect-solflare"><i class="bi bi-wallet2"></i> Solflare</a></li>
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="accountDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> Account
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="accountDropdown">
                            <li><span class="dropdown-item-text">Balance: <span id="wallet-balance">0 ETH</span></span></li>
                            <li><span class="dropdown-item-text">Network: <span id="wallet-network">-</span></span></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/settings"><i class="bi bi-gear"></i> Settings</a></li>
                            <li><a class="dropdown-item" href="#" id="disconnect-wallet"><i class="bi bi-box-arrow-right"></i> Disconnect</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Portfolio Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Portfolio Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <canvas id="portfolio-chart"></canvas>
                            </div>
                            <div class="col-md-6">
                                <h3 class="mb-3">$<span id="total-balance">0.00</span></h3>
                                <div class="mb-3">
                                    <span class="text-muted">24h P&L:</span>
                                    <span id="pnl-24h" class="ms-2">0.00%</span>
                                </div>
                                <div class="mb-3">
                                    <span class="text-muted">Active Trades:</span>
                                    <span id="active-trades" class="ms-2">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity and Notifications -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Pair</th>
                                        <th>Action</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-activity">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div id="notifications">
                            <!-- Notifications will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Data and Charts -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Market Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="chart-container">
                                    <canvas id="market-chart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="table-responsive">
                                    <table class="table table-dark">
                                        <thead>
                                            <tr>
                                                <th>Metric</th>
                                                <th>Value</th>
                                            </tr>
                                        </thead>
                                        <tbody id="market-metrics">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/wallet-adapter-base@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/wallet-adapter-phantom@latest/lib/index.iife.min.js"></script>
    <script>
        // Initialize charts
        function initializeCharts() {
            // Portfolio Chart
            const portfolioCtx = document.getElementById('portfolio-chart').getContext('2d');
            const portfolioChart = new Chart(portfolioCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#ffd700',
                            '#00f3ff',
                            '#b388ff',
                            '#b86c25'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff8e1'
                            }
                        }
                    }
                }
            });

            // Market Chart
            const marketCtx = document.getElementById('market-chart').getContext('2d');
            const marketChart = new Chart(marketCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'BTC/USDT',
                        data: [],
                        borderColor: '#ffd700',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff8e1'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: '#fff8e1'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour'
                            },
                            ticks: {
                                color: '#fff8e1'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            // Store chart instances for updates
            window.portfolioChart = portfolioChart;
            window.marketChart = marketChart;
        }

        // Initialize charts when the page loads
        document.addEventListener('DOMContentLoaded', initializeCharts);

        // Initialize update intervals
        let updateIntervals = {
            portfolio: null,
            marketData: null,
            recentActivity: null,
            notifications: null
        };

        // Clear all update intervals
        function clearAllIntervals() {
            Object.values(updateIntervals).forEach(interval => {
                if (interval) clearInterval(interval);
            });
        }

        // Show error message
        function showError(message) {
            const notificationsContainer = document.getElementById('notifications-container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show';
            errorDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            notificationsContainer.insertBefore(errorDiv, notificationsContainer.firstChild);
        }

        // Show success message
        function showSuccess(message) {
            const notificationsContainer = document.getElementById('notifications-container');
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success alert-dismissible fade show';
            successDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            notificationsContainer.insertBefore(successDiv, notificationsContainer.firstChild);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check API status first
                const statusResponse = await fetch('/api/bot_status');
                const statusData = await statusResponse.json();
                
                if (statusData.status === 'error') {
                    showError(statusData.message || 'Failed to initialize API');
                    return;
                }
                
                // Start update intervals only if API is initialized
                if (statusData.running !== undefined) {
                    // Initialize update intervals
                    updateIntervals.portfolio = setInterval(updatePortfolio, 5000);
                    updateIntervals.marketData = setInterval(updateMarketData, 5000);
                    updateIntervals.recentActivity = setInterval(updateRecentActivity, 5000);
                    updateIntervals.notifications = setInterval(updateNotifications, 5000);
                    
                    // Initial updates
                    updatePortfolio();
                    updateMarketData();
                    updateRecentActivity();
                    updateNotifications();
                } else {
                    showError('API not properly initialized');
                }
            } catch (error) {
                console.error('Error during initialization:', error);
                showError('Failed to initialize application: ' + error.message);
            }
        });

        // Update functions
        async function updateStatus() {
            try {
                const response = await fetch('/api/bot_status');
                const data = await response.json();
                
                // Update status badge
                const statusBadge = document.getElementById('bot-status-badge');
                if (data.running) {
                    statusBadge.className = 'status-badge status-live';
                    statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> LIVE';
                } else {
                    statusBadge.className = 'status-badge status-offline';
                    statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> OFFLINE';
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        async function updatePortfolio() {
            try {
                const response = await fetch('/api/portfolio');
                const data = await response.json();
                
                if (data.status === 'error') {
                    showError(data.message);
                    return;
                }
                
                if (data.status === 'success' && data.balances) {
                    // Calculate total balance
                    const totalBalance = data.balances.reduce((sum, asset) => 
                        sum + parseFloat(asset.usdt_value || 0), 0);
                    
                    // Update total balance display
                    document.getElementById('total-balance').textContent = totalBalance.toFixed(2);
                    
                    // Update P&L if available
                    if (data.pnl_24h !== undefined) {
                        const pnlElement = document.getElementById('pnl-24h');
                        const pnlValue = parseFloat(data.pnl_24h);
                        pnlElement.textContent = `${pnlValue >= 0 ? '+' : ''}${pnlValue.toFixed(2)}%`;
                        pnlElement.className = `ms-2 ${pnlValue >= 0 ? 'text-success' : 'text-danger'}`;
                    }
                    
                    // Update active trades count
                    if (data.active_trades !== undefined) {
                        document.getElementById('active-trades').textContent = data.active_trades;
                    }

                    // Update portfolio chart
                    if (window.portfolioChart) {
                        const nonZeroBalances = data.balances.filter(asset => 
                            parseFloat(asset.usdt_value || 0) > 0
                        );
                        
                        window.portfolioChart.data.labels = nonZeroBalances.map(asset => asset.asset);
                        window.portfolioChart.data.datasets[0].data = nonZeroBalances.map(asset => 
                            parseFloat(asset.usdt_value || 0)
                        );
                        window.portfolioChart.update();
                    }
                }
            } catch (error) {
                console.error('Error updating portfolio:', error);
                showError('Failed to update portfolio data. Please try again later.');
            }
        }

        async function updateMarketData() {
            try {
                const response = await fetch('/api/market_data');
                const data = await response.json();
                
                if (data.status === 'error') {
                    showError(data.message);
                    return;
                }
                
                if (data.status === 'success' && data.klines) {
                    // Update market chart
                    if (window.marketChart) {
                        const chartData = data.klines.map(kline => ({
                            x: new Date(kline.timestamp),
                            y: parseFloat(kline.close)
                        }));
                        
                        window.marketChart.data.datasets[0].data = chartData;
                        window.marketChart.update();
                    }

                    // Update market metrics
                    if (data.metrics) {
                        const metricsTable = document.getElementById('market-metrics');
                        metricsTable.innerHTML = '';
                        
                        const metrics = [
                            { label: '24h Volume', value: `$${parseFloat(data.metrics.volume_24h).toLocaleString()}` },
                            { label: '24h High', value: `$${parseFloat(data.metrics.high_24h).toLocaleString()}` },
                            { label: '24h Low', value: `$${parseFloat(data.metrics.low_24h).toLocaleString()}` },
                            { label: 'Price Change', value: `${data.metrics.price_change_24h >= 0 ? '+' : ''}${data.metrics.price_change_24h}%` }
                        ];

                        metrics.forEach(metric => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${metric.label}</td>
                                <td>${metric.value}</td>
                            `;
                            metricsTable.appendChild(row);
                        });
                    }
                }
            } catch (error) {
                console.error('Error updating market data:', error);
                showError('Failed to update market data. Please try again later.');
            }
        }

        async function updateRecentActivity() {
            try {
                const response = await fetch('/api/recent_activity');
                const data = await response.json();
                
                if (data.status === 'error') {
                    showError(data.message);
                    return;
                }
                
                const tbody = document.getElementById('recent-activity');
                tbody.innerHTML = '';
                
                if (data.status === 'success' && data.activity) {
                    data.activity.forEach(activity => {
                        const row = document.createElement('tr');
                        const timestamp = new Date(activity.time).toLocaleString();
                        const amount = parseFloat(activity.total).toLocaleString('en-US', {
                            style: 'currency',
                            currency: 'USD'
                        });
                        
                        row.innerHTML = `
                            <td>${timestamp}</td>
                            <td>${activity.symbol}</td>
                            <td>${activity.side}</td>
                            <td>${amount}</td>
                            <td><span class="badge ${activity.side === 'BUY' ? 'bg-success' : 'bg-danger'}">${activity.side}</span></td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error updating recent activity:', error);
                showError('Failed to update recent activity. Please try again later.');
            }
        }

        async function updateNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const data = await response.json();
                
                if (data.status === 'error') {
                    showError(data.message);
                    return;
                }
                
                const container = document.getElementById('notifications');
                container.innerHTML = '';
                
                if (data.status === 'success' && data.notifications) {
                    data.notifications.forEach(notification => {
                        const div = document.createElement('div');
                        div.className = `notification notification-${notification.type}`;
                        div.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${notification.type}</h6>
                                    <p class="mb-1">${notification.message}</p>
                                </div>
                                <small>${new Date(notification.time).toLocaleTimeString()}</small>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Error updating notifications:', error);
                showError('Failed to update notifications. Please try again later.');
            }
        }

        // Initialize Solana connection
        let connection;
        let wallet;
        let currentAccount = null;

        async function initSolana() {
            try {
                // Initialize Solana connection
                connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));
                
                // Check if Phantom is installed
                if (!window.solana || !window.solana.isPhantom) {
                    showPhantomInstallGuide();
                    return;
                }

                // Initialize Phantom wallet
                wallet = new solanaWalletAdapterPhantom.PhantomWalletAdapter();
                await wallet.connect();

                if (wallet.connected) {
                    currentAccount = wallet.publicKey.toString();
                    await connectWallet(currentAccount);
                }

                // Set up event listeners
                wallet.on('connect', handleWalletConnect);
                wallet.on('disconnect', handleWalletDisconnect);
                wallet.on('accountChanged', handleAccountChanged);
            } catch (error) {
                console.error("Error initializing Solana:", error);
                showError("Failed to initialize Solana connection. Please try again.");
            }
        }

        function showPhantomInstallGuide() {
            const notifications = document.getElementById('notifications');
            const guideDiv = document.createElement('div');
            guideDiv.className = 'notification notification-info';
            guideDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">Install Phantom Wallet</h6>
                        <p class="mb-1">To use this application, you need to install Phantom Wallet:</p>
                        <ol class="mb-2">
                            <li>Visit <a href="https://phantom.app/download" target="_blank" class="text-light">Phantom.app</a></li>
                            <li>Click "Download" and install the extension</li>
                            <li>Create a new wallet or import an existing one</li>
                            <li>Refresh this page after installation</li>
                        </ol>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            `;
            notifications.insertBefore(guideDiv, notifications.firstChild);

            // Disable wallet connection buttons
            const connectButtons = document.querySelectorAll('#connect-phantom, #connect-solflare');
            connectButtons.forEach(button => {
                button.classList.add('disabled');
                button.style.opacity = '0.5';
            });
        }

        async function handleWalletConnect() {
            if (wallet.connected) {
                currentAccount = wallet.publicKey.toString();
                await connectWallet(currentAccount);
            }
        }

        async function handleWalletDisconnect() {
            await disconnectWallet();
        }

        async function handleAccountChanged(publicKey) {
            if (publicKey) {
                currentAccount = publicKey.toString();
                await connectWallet(currentAccount);
            } else {
                await disconnectWallet();
            }
        }

        async function connectWallet(address) {
            try {
                // Get wallet balance
                const balance = await connection.getBalance(wallet.publicKey);
                const balanceSol = balance / solanaWeb3.LAMPORTS_PER_SOL;
                
                // Get network information
                const network = await connection.getVersion();
                const networkName = {
                    'mainnet-beta': 'Solana Mainnet',
                    'testnet': 'Solana Testnet',
                    'devnet': 'Solana Devnet'
                }[network['solana-core']] || `Unknown Network (${network['solana-core']})`;

                // Update UI first
                updateWalletInfo({
                    address: address,
                    balance: balanceSol,
                    network: networkName
                });

                try {
                    // Send wallet info to backend
                    const response = await fetch('/api/wallet_connected', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            address: address,
                            balance: balanceSol,
                            network: networkName
                        })
                    });
                    
                    const data = await response.json();
                    if (data.status === 'success') {
                        showSuccess("Wallet connected successfully!");
                    } else {
                        showError(data.message || "Failed to connect wallet");
                    }
                } catch (error) {
                    console.error("Error connecting to backend:", error);
                    showError("Connected to wallet but failed to sync with backend. Some features may be limited.");
                }
            } catch (error) {
                console.error("Error connecting wallet:", error);
                showError("Failed to connect wallet. Please try again.");
            }
        }

        function updateWalletInfo(walletInfo) {
            const balanceElement = document.getElementById('wallet-balance');
            const networkElement = document.getElementById('wallet-network');
            
            if (walletInfo) {
                balanceElement.textContent = `${walletInfo.balance} ETH`;
                networkElement.textContent = walletInfo.network;
            } else {
                balanceElement.textContent = '0 ETH';
                networkElement.textContent = '-';
            }
        }

        async function disconnectWallet() {
            if (currentAccount) {
                try {
                    const response = await fetch('/api/wallet_disconnected', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ address: currentAccount })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        currentAccount = null;
                        updateWalletInfo(null);
                        showSuccess("Wallet disconnected successfully!");
                    } else {
                        showError(data.message || "Failed to disconnect wallet");
                    }
                } catch (error) {
                    console.error("Error disconnecting wallet:", error);
                    showError("Failed to disconnect wallet. Please try again.");
                }
            }
        }
    </script>
</body>
</html> 